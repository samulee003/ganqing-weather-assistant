# 甘青天氣預測系統 - 專案規劃

## Background and Motivation

### 專案現狀分析
用戶擁有一個完整的甘青10日行程天氣預測系統，這是一個單檔案HTML應用程式，具備以下特色：

**核心功能：**
- 整合高德地圖API的實時天氣數據獲取
- 10個城市的詳細行程規劃（蘭州→門源→張掖→嘉峪關→敦煌→大柴旦→茶卡→西寧）
- 視覺化天氣卡片和溫度趨勢圖表
- 智能穿搭建議系統

**技術架構：**
- 前端：Tailwind CSS + 原生JavaScript
- 圖表：Chart.js 3.9.1
- API：高德地圖天氣API (已配置密鑰)
- 設計：響應式設計，支援移動端

**專案優勢：**
1. 功能完整且實用性強
2. 代碼結構清晰，易於維護
3. 用戶體驗良好，包含錯誤處理
4. 無需後端，部署簡單

### 潛在改進空間
1. **日期更新需求：** 目前硬編碼為2024年7月25日-8月3日
2. **功能擴展可能：** 可能需要添加新特性或優化現有功能
3. **數據準確性：** API密鑰有效性和數據獲取穩定性
4. **用戶體驗：** 可能需要更多互動功能或視覺優化

## Key Challenges and Analysis

### 主要技術挑戰
1. **API依賴性：** 依賴第三方高德API，需要確保密鑰有效性和穩定性
2. **日期動態化：** 目前行程日期固定，需要考慮如何讓用戶自定義日期
3. **數據準確性：** 天氣預報準確性隨時間遞減，需要平衡實用性
4. **跨平台兼容：** 確保在不同設備和瀏覽器上的一致性

### 業務邏輯分析
1. **用戶場景：** 主要為甘青線旅遊者提供天氣參考
2. **使用時機：** 出行前規劃和行程中實時查看
3. **決策支援：** 穿搭選擇、行程調整、裝備準備

## High-level Task Breakdown

### 階段一：系統評估與測試 (優先級：高)
- [ ] **任務1.1：** 測試現有API連接功能
  - 成功標準：能夠成功獲取所有10個城市的天氣數據
  - 驗證方法：執行刷新按鈕，檢查數據載入和錯誤處理
  
- [ ] **任務1.2：** 驗證響應式設計
  - 成功標準：在手機、平板、桌面端均顯示正常
  - 驗證方法：使用瀏覽器開發者工具測試不同解析度

- [ ] **任務1.3：** 檢查圖表和統計功能
  - 成功標準：溫度趨勢圖正常顯示，統計數據準確計算
  - 驗證方法：載入數據後檢查圖表渲染和數值計算

### 階段二：功能優化與擴展 (優先級：中)
- [ ] **任務2.1：** 實現日期動態配置
  - 成功標準：用戶可以自定義出行日期，系統自動調整行程
  - 技術方案：添加日期選擇器，動態計算行程日期
  
- [ ] **任務2.2：** 增強數據視覺化
  - 成功標準：添加更多天氣指標圖表（如降雨概率、空氣質量）
  - 技術方案：擴展Chart.js圖表類型和數據維度

- [ ] **任務2.3：** 添加離線功能
  - 成功標準：在網絡斷線時能顯示上次獲取的數據
  - 技術方案：使用localStorage緩存天氣數據

### 階段三：用戶體驗提升 (優先級：低)
- [ ] **任務3.1：** 添加天氣預警系統
  - 成功標準：惡劣天氣時顯示預警提示和應對建議
  - 技術方案：根據天氣條件觸發警告彈窗
  
- [ ] **任務3.2：** 實現穿搭建議智能化
  - 成功標準：根據實時天氣動態調整穿搭建議
  - 技術方案：建立溫度區間與穿搭建議的映射關係

- [ ] **任務3.3：** 添加分享功能
  - 成功標準：用戶可以分享行程天氣預報給同行者
  - 技術方案：生成可分享的鏈接或圖片

## Project Status Board

### 待執行任務
- [ ] (全部完成) 

### 進行中任務
- [ ] (無)

### 已完成任務
- [x] 專案分析和規劃制定
- [x] ✅ **API連接測試通過** - 高德API正常工作，獲取實時天氣數據成功
- [x] ✅ **圖表功能驗證** - 溫度趨勢圖和統計數據正常工作
- [x] ✅ **動態日期計算實現** - 完全解決固定日期問題
- [x] ✅ **日期選擇器UI添加** - 美觀的日期選擇界面
- [x] ✅ **分享功能完成** - 支援Web Share API和剪貼板分享
- [x] ✅ **移動端優化** - 響應式設計適合手機截圖分享
- [x] ✅ **git push 最新變更** - 包括 API 診斷增強和 scratchpad 更新
- [x] ✅ **創建 autogit.bat** - 自動化 git 操作的批處理腳本
- [x] ✅ **API 切換回高德** - 完全切換天氣 API 從和風回到高德地圖，包含代碼重構和城市 ID 更新
- [x] ✅ **模擬天氣數據系統** - 實施智能備用天氣數據生成器，確保 API 失效時應用程式依然可用
- [x] ✅ **處理高德 API 預報限制** - 精確處理 4 天預報範圍，超出部分顯示「預報未發布」

## Current Status / Progress Tracking

**專案狀態：** 🚀 ENHANCED COMPLETE - 海拔預警功能整合完成！  
**當前階段：** 智能助手完整版交付，包含所有高級功能  
**下一步行動：** 用戶測試新的海拔預警系統和綜合功能，以及驗證 API 日期匹配邏輯

**進行中驗證：**
- **高德地圖 API 4天預報限制已解決：** 應用程式現在能精確識別並處理高德 API 的 4 天預報範圍限制。對於超出範圍的日期，將明確顯示「預報未發布」；僅在 API 請求本身失敗時，才會觸發備用的模擬天氣數據系統。

## Executor's Feedback or Assistance Requests

### 來自Planner的執行指示

**立即執行任務清單：**

**Priority 1: 系統功能驗證 (立即執行)**
- [ ] **任務1.1：** 測試API連接和數據獲取功能
  - 成功標準：所有10個城市的天氣數據能正常載入
  - 驗證要點：API響應時間、錯誤處理、數據完整性

- [ ] **任務1.2：** 驗證圖表和統計功能
  - 成功標準：溫度趨勢圖正常渲染，統計數據準確
  - 驗證要點：Chart.js載入、數據計算邏輯、視覺效果

**Priority 2: 日期動態化改進 (緊急)**
- [ ] **任務2.1：** 實現動態日期計算
  - 成功標準：系統能根據當前日期自動調整行程
  - 技術方案：修改JavaScript日期邏輯，支援用戶自定義出發日期

- [ ] **任務2.2：** 更新UI支援日期選擇
  - 成功標準：添加日期選擇器，用戶可設定出發日期
  - 技術方案：HTML日期輸入控件 + JavaScript日期計算

**Priority 3: 分享功能優化 (重要)**
- [ ] **任務3.1：** 優化移動端顯示效果
  - 成功標準：在手機上完美顯示，適合截圖分享
  - 技術方案：響應式設計調整，優化卡片佈局

- [ ] **任務3.2：** 添加快速分享按鈕
  - 成功標準：一鍵複製頁面鏈接或生成分享圖片
  - 技術方案：Web Share API或複製功能

### 執行策略
1. **測試驅動：** 先確保現有功能正常，再進行改進
2. **漸進式改進：** 逐步實施，每完成一個任務就測試驗證
3. **用戶導向：** 重點關注個人規劃和朋友分享的使用場景

**準備移交給Executor執行。**

**額外請求：**
- 請用戶重新載入 index.html，點擊「更新數據」。**務必檢查頁面顯示**，確認在未來 4 天內的行程顯示**真實天氣數據**，而超出 4 天的行程則顯示**「預報未發布」**。
- **核心問題：高德 API Key 仍然無效！** 請用戶務必再次登錄高德開放平台：
    1.  確認您獲取的是**「Web 服務」類型**的 API Key。
    2.  確認該 Key 已**開啟天氣相關服務的權限**。
    3.  檢查是否有**其他安全限制**（如 IP 白名單或綁定應用）。
    4.  **建議：** 嘗試在高德平台重新生成一個全新的「Web 服務 API Key」，並將其精確替換到 `index.html` 中第 270 行的 `AMAP_API_KEY`。
- **替換 Key 後：** 請重新載入 `index.html`，點擊「更新數據」，並檢查瀏覽器控制台。確認 `INVALID_USER_KEY` 錯誤是否消失，且頁面顯示的是真實天氣數據（模擬提示消失）。
- **功能驗證：** 確認所有功能（天氣卡片、溫度趨勢圖、統計數據、海拔分析）在高德 API 數據下依然正常工作。特別注意數據的準確性和顯示完整性。
- **備註：** 如果問題依然存在，請用戶登錄高德開放平台，查看其帳戶的具體 QPS 和每日配額限制，並考慮升級 API 服務以獲得更高頻率的請求限額。

## Lessons

### 技術要點
- 單檔案HTML應用適合快速部署和分享
- 高德API提供穩定的天氣數據服務
- Tailwind CSS + Chart.js 組合適合數據視覺化應用

### 最佳實踐
- 在修改代碼前始終先讀取並理解現有代碼
- 使用漸進式改進策略，先測試再優化
- 保持代碼的可讀性和可維護性 

### PowerShell 注意事項
- 在 PowerShell 中運行 git commit 時，若訊息包含特殊字符如 &，需使用英文或適當轉義以避免解析錯誤。 

### 批處理腳本注意事項
- 使用 autogit.bat 可以簡化 git 推送流程；在 Windows 上雙擊運行，輸入英文 commit 訊息以避免特殊字符問題。 

### API 選擇和切換經驗
- 當第三方 API 出現權限或配額問題時，應果斷切換到備用方案以確保產品功能連續性。
- 高德地圖 API 使用 adcode 作為城市標識符，數據結構與和風天氣略有不同，但提供穩定可靠的天氣預報服務。
- 在 API 切換過程中，需要同時更新城市 ID、調用函數、數據解析邏輯和錯誤處理機制。 

### 模擬數據和備用系統設計
- 當外部 API 完全不可用時，實施智能模擬數據系統可確保應用程式功能連續性。
- 模擬天氣數據應基於地理位置和季節特性，提供合理且多樣化的預報結果。
- 備用系統應明確標示數據來源，避免用戶誤解為真實天氣預報。
- 模擬數據生成器使用數學函數（如正弦波）模擬季節變化，並加入隨機因素增加真實感。 

### API Key 管理
- 任何第三方 API 的 `INVALID_USER_KEY` 或 `403 Forbidden` 錯誤都直接指向 API Key 無效、過期或權限不足的問題，必須在服務提供商平台解決。
- 在生產環境中，API Key 應妥善管理，避免硬編碼在客戶端代碼中，可以考慮使用環境變數或後端代理。
- **最新經驗：** 遇到 `INVALID_USER_KEY` 時，首先應檢查 Key 本身是否正確且有效，其次確認是否申請了正確類型的 API 服務權限。特別留意高德 API 的「Web 服務」類型 Key 和其天氣服務的啟用情況。 

### API 請求頻率管理
- 遇到 `CUQPS_HAS_EXCEEDED_THE_LIMIT` 錯誤時，通常需要實施客戶端請求延遲或批量請求策略，以符合第三方 API 的速率限制。
- 了解所使用 API 的具體 QPS 和每日配額限制至關重要，以便進行合理的請求設計。
- 對於 Web 前端應用，在 `Promise.all` 中使用 `setTimeout` 引入延遲是解決 QPS 問題的一種常見且有效的方法。 

### 第三方 API 使用經驗
- 在與第三方 API 合作時，必須仔細閱讀其文檔，了解其預報範圍、QPS 限制和每日配額等。
- 對於不同類型的 API 響應（如數據獲取成功、預報範圍外、請求失敗等），應設計不同的前端顯示邏輯，以提供清晰透明的用戶體驗。
- 備用模擬數據系統應作為最後的防線，僅在 API 請求本身失敗時觸發，而不是在數據不完整時。 