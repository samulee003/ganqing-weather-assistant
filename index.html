<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç”˜é’10æ—¥è¡Œç¨‹æ™ºèƒ½åŠ©æ‰‹ï¼ˆå®Œæ•´ç‰ˆï¼‰</title>
  <script src="https://cdn.tailwindcss.com/3.3.3"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    body { font-family: 'Noto Sans SC', sans-serif; background: #f8fafc; color: #1e293b; }
    .card { transition: all 0.3s ease; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    .card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    .tag { display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
    .sunny { background: #fef3c7; color: #92400e; }
    .cloudy { background: #e0e7ff; color: #3730a3; }
    .rainy { background: #dbeafe; color: #1e40af; }
    .alt-low { background: #d1fae5; color: #065f46; }
    .alt-mid { background: #fed7aa; color: #9a3412; }
    .alt-high { background: #fecaca; color: #991b1b; }
    .den-low { background: linear-gradient(135deg, #d1fae5, #a7f3d0); }
    .den-mid { background: linear-gradient(135deg, #fef3c7, #fde68a); }
    .den-high { background: linear-gradient(135deg, #fecaca, #fca5a5); }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal-content { background: #fff; margin: 5% auto; padding: 20px; border-radius: 12px; width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto; }
    .poi-card { transition: all 0.2s; cursor: pointer; }
    .poi-card:hover { transform: translateX(5px); background: #f1f5f9; }
    .spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .tab-active { background: #3b82f6; color: white; }
    .tab-inactive { background: #e5e7eb; color: #6b7280; }
    .warning { animation: pulse 2s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    .chart { height: 300px; position: relative; }
    .scroll { max-height: 400px; overflow-y: auto; }
    .refresh-btn { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
    .refresh-btn:hover { background: linear-gradient(135deg, #2563eb, #1e40af); }
  </style>
</head>
<body class="min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <!-- é ­éƒ¨ -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-slate-800 mb-2">ç”˜é’10æ—¥è¡Œç¨‹æ™ºèƒ½åŠ©æ‰‹</h1>
      <div class="mb-4">
        <label for="tripStartDate" class="block text-sm font-medium text-gray-700 mb-2">é¸æ“‡å‡ºç™¼æ—¥æœŸï¼š</label>
        <div class="flex justify-center items-center gap-4">
          <input type="date" id="tripStartDate" 
                 class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                 onchange="updateTripDates()">
          <button onclick="setToday()" 
                  class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
            <i class="fas fa-calendar-day mr-2"></i>è¨­ç‚ºä»Šå¤©
          </button>
        </div>
      </div>
      <p id="tripDateRange" class="text-slate-600 mb-4">é¸æ“‡æ—¥æœŸå¾Œé¡¯ç¤ºè¡Œç¨‹æ™‚é–“ | å¤©æ°£é å ±ãƒ»æµ·æ‹”åˆ†æ</p>
    </div>

    <!-- åˆ†é å°èˆª -->
    <div class="flex flex-wrap justify-center gap-2 mb-8">
      <button onclick="switchTab('weather')" id="tab-weather" class="px-6 py-2 rounded-lg font-medium tab-active transition-all">
        <i class="fas fa-cloud-sun mr-2"></i>å¤©æ°£é å ±
      </button>
              <button onclick="switchTab('altitude')" id="tab-altitude" class="px-6 py-2 rounded-lg font-medium tab-inactive transition-all">
          <i class="fas fa-mountain mr-2"></i>æµ·æ‹”åˆ†æ
        </button>
      <button onclick="loadAll()" class="px-6 py-2 rounded-lg font-medium bg-gradient-to-r from-purple-500 to-pink-500 text-white hover:shadow-lg transition-all">
        <i class="fas fa-sync-alt mr-2"></i>æ›´æ–°æ•¸æ“š
      </button>
      <button onclick="shareWeatherForecast()" 
              class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 hover:shadow-lg transition-all duration-300">
        <i class="fas fa-share mr-2"></i>åˆ†äº«è¡Œç¨‹
      </button>
    </div>

    <div id="content">
      <!-- å¤©æ°£é å ±é é¢ -->
      <div id="weather-section" class="tab-content">
        <div id="weather-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-12">
          <div class="col-span-full text-center py-12">
            <i class="fas fa-spinner spinner text-4xl text-blue-500 mb-4"></i>
            <p class="text-lg">è¼‰å…¥å¤©æ°£æ•¸æ“šä¸­...</p>
          </div>
        </div>

        <!-- æº«åº¦è¶¨å‹¢åœ–è¡¨ -->
        <div id="chartSection" class="bg-white rounded-xl p-6 mb-12" style="display: none;">
          <h2 class="text-xl font-semibold mb-6"><i class="fas fa-chart-line mr-2"></i>å…¨è¡Œç¨‹æº«åº¦è¶¨å‹¢</h2>
          <div class="chart-container">
            <canvas id="tempChart"></canvas>
          </div>
        </div>

        <!-- çµ±è¨ˆä¿¡æ¯ -->
        <div id="statsSection" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12" style="display: none;">
          <div class="bg-white rounded-xl p-6 text-center">
            <i class="fas fa-thermometer-half text-3xl text-red-500 mb-3"></i>
            <h3 class="font-semibold text-gray-700">å¹³å‡æº«åº¦</h3>
            <p id="avgTemp" class="text-2xl font-bold text-red-500">--Â°C</p>
          </div>
          <div class="bg-white rounded-xl p-6 text-center">
            <i class="fas fa-eye text-3xl text-blue-500 mb-3"></i>
            <h3 class="font-semibold text-gray-700">æœ€ä½³å¤©æ°£å¤©æ•¸</h3>
            <p id="goodWeatherDays" class="text-2xl font-bold text-blue-500">-- å¤©</p>
          </div>
          <div class="bg-white rounded-xl p-6 text-center">
            <i class="fas fa-umbrella text-3xl text-gray-500 mb-3"></i>
            <h3 class="font-semibold text-gray-700">éœ€è¦é›¨å…·å¤©æ•¸</h3>
            <p id="rainyDays" class="text-2xl font-bold text-gray-500">-- å¤©</p>
          </div>
        </div>
      </div>

      <!-- æµ·æ‹”åˆ†æé é¢ -->
      <div id="altitude-section" class="tab-content hidden">
        <div class="bg-white rounded-xl p-6 mb-8">
          <h2 class="text-2xl font-bold mb-6"><i class="fas fa-chart-area mr-2"></i>å…¨ç¨‹æµ·æ‹”è®ŠåŒ–åœ–</h2>
          <div class="chart">
            <canvas id="altChart"></canvas>
          </div>
          <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-gradient-to-br from-white to-gray-50 rounded-lg p-4 text-center">
              <i class="fas fa-arrow-up text-3xl text-red-500 mb-2"></i>
              <h3 class="font-semibold">æœ€é«˜æµ·æ‹”</h3>
              <p id="maxAlt" class="text-2xl font-bold text-red-500">-- m</p>
            </div>
            <div class="bg-gradient-to-br from-white to-gray-50 rounded-lg p-4 text-center">
              <i class="fas fa-arrow-down text-3xl text-green-500 mb-2"></i>
              <h3 class="font-semibold">æœ€ä½æµ·æ‹”</h3>
              <p id="minAlt" class="text-2xl font-bold text-green-500">-- m</p>
            </div>
            <div class="bg-gradient-to-br from-white to-gray-50 rounded-lg p-4 text-center">
              <i class="fas fa-exclamation-triangle text-3xl text-orange-500 mb-2"></i>
              <h3 class="font-semibold">é«˜åŸåæ‡‰é¢¨éšª</h3>
              <p id="altRisk" class="text-xl font-bold text-orange-500">--</p>
            </div>
          </div>
        </div>
        <div id="alt-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      </div>



      
    </div>

    <!-- æ¨¡æ…‹å°è©±æ¡† -->
    <div id="modal" class="modal">
      <div class="modal-content">
        <span onclick="closeModal()" class="float-right cursor-pointer text-2xl hover:text-red-500">&times;</span>
        <h2 id="modalTitle" class="text-2xl font-bold mb-4"></h2>
        <div id="modalContent" class="space-y-4"></div>
      </div>
    </div>
  </div>

  <script>
    // --- API Key é…ç½® ---
    // é«˜å¾·åœ°åœ– API Key
    const AMAP_API_KEY = '7f9b70b7534ed08f8d1bd7beb673ab3f';
    
    // --- å…¨åŸŸè®Šæ•¸ ---
    let tripStartDate = new Date();
    let altChart, tempChart;
    
    // --- åŸºç¤è¡Œç¨‹é…ç½® (ä½¿ç”¨é«˜å¾·åœ°åœ–åŸå¸‚ID) ---
    const baseItineraryConfig = [
      { day: "D1", location: "è˜­å·", adcode: "620100", alt: 1520, itinerary: "ä¸‹åˆ4é»æŠµé”ï¼Œé…’åº—å…¥ä½ï¼Œæ™šé¤ï¼Œé»ƒæ²³å¤œæ™¯", outfit: "è¼•ä¾¿ä¼‘é–’è£" },
      { day: "D2", location: "è˜­å·", adcode: "620100", alt: 1520, itinerary: "ç”˜è‚…çœåšç‰©é¤¨ï¼Œäº”æ³‰å±±å…¬åœ’ï¼Œè˜­å·è€è¡—", outfit: "æ–‡åŒ–è£ï¼šé•·è¤²+é˜²æ›¬å¸½" },
      { day: "D3", location: "é–€æº", adcode: "632221", alt: 2880, itinerary: "é–€æºæ²¹èœèŠ±ï¼Œç¥é€£å±±è‰åŸ", outfit: "æˆ¶å¤–è£ï¼šé€Ÿå¹²é•·è¢–+é˜²é¢¨å¤–å¥—" },
      { day: "D4", location: "å¼µæ–", adcode: "620700", alt: 1474, itinerary: "å¹³å±±æ¹–å¤§å³½è°·ï¼Œä¸ƒå½©ä¸¹éœ", outfit: "æˆ¶å¤–æ”å½±è£ï¼šé˜²é¢¨å¤–å¥—+é˜²æ»‘é‹" },
      { day: "D5", location: "å˜‰å³ªé—œ", adcode: "620200", alt: 1650, itinerary: "å˜‰å³ªé—œé—œåŸï¼Œé•·åŸç¬¬ä¸€å¢©", outfit: "æ–‡åŒ–éŠï¼šæ£‰éº»é•·è¢–+é®é™½å¸½" },
      { day: "D6", location: "æ•¦ç…Œ", adcode: "620982", alt: 1139, itinerary: "è«é«˜çªŸï¼Œé³´æ²™å±±æœˆç‰™æ³‰", outfit: "æ²™æ¼ è£ï¼šé˜²é¢¨æ²™çœ¼é¡+é ­å·¾" },
      { day: "D7", location: "å¤§æŸ´æ—¦", adcode: "632857", alt: 3173, itinerary: "çµ²ç¶¢éºå€åŸï¼Œé»‘ç¨å±±", outfit: "æ¢ç´¢è£ï¼šå·¥è£å¤–å¥—+é˜²æ»‘é´" },
      { day: "D8", location: "èŒ¶å¡", adcode: "632725", alt: 3059, itinerary: "æ°´ä¸Šé›…ä¸¹ï¼Œå‰å¾€èŒ¶å¡é¹½æ¹–", outfit: "é¹½æ¹–è£ï¼šäº®è‰²é•·è£™/è¤²+æ‹–é‹" },
      { day: "D9", location: "èŒ¶å¡", adcode: "632725", alt: 3059, itinerary: "èŒ¶å¡é¹½æ¹–å…¨æ—¥éŠï¼ˆå¤©ç©ºä¹‹é¡ï¼‰", outfit: "æ”å½±è£ï¼šé®®è±”è‰²å½©è¡£ç‰©" },
      { day: "D10", location: "è¥¿å¯§", adcode: "630100", alt: 2261, itinerary: "é’æµ·æ¹–ï¼Œæ—¥æœˆå±±ï¼Œè¿”å›è¥¿å¯§", outfit: "è¿”ç¨‹è£ï¼šèˆ’é©ä¾¿è£" }
    ];

    // å‹•æ…‹ç”Ÿæˆå¸¶æ—¥æœŸçš„è¡Œç¨‹é…ç½®
    function getItineraryConfig(startDate = tripStartDate) {
      return baseItineraryConfig.map((item, index) => {
        const currentDate = new Date(startDate);
        currentDate.setDate(currentDate.getDate() + index);
        return {
          ...item,
          date: `${currentDate.getMonth() + 1}/${currentDate.getDate()}`,
          fullDate: currentDate.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' }),
          isoDate: currentDate.toISOString().split('T')[0]
        };
      });
    }

    // --- åˆå§‹åŒ–èˆ‡äº‹ä»¶ç¶å®š ---
    window.onload = function() {
      setToday();
    };

    // --- ä¸»æµç¨‹æ§åˆ¶ ---
    async function loadAll() {
      showLoading();
      try {
        await Promise.all([loadWeather(), loadAltitude()]);
      } catch(e) {
        console.error('æ•¸æ“šè¼‰å…¥éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', e);
        showError('æ•¸æ“šè¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°ã€‚');
      }
    }

    function switchTab(t) {
      document.querySelectorAll('[id^="tab-"]').forEach(b => {
        b.classList.toggle('tab-active', b.id === `tab-${t}`);
        b.classList.toggle('tab-inactive', b.id !== `tab-${t}`);
      });
      document.querySelectorAll('.tab-content').forEach(s => s.classList.add('hidden'));
      document.getElementById(`${t}-section`).classList.remove('hidden');
    }

    // --- æ—¥æœŸç®¡ç† ---
    function updateTripDates() {
      const dateInput = document.getElementById('tripStartDate');
      if (dateInput.value) {
        tripStartDate = new Date(dateInput.value);
        updateDateRangeDisplay();
        loadAll();
      }
    }

    function setToday() {
      const today = new Date();
      tripStartDate = today;
      document.getElementById('tripStartDate').value = today.toISOString().split('T')[0];
      updateDateRangeDisplay();
      loadAll();
    }

    function updateDateRangeDisplay() {
      const startDate = new Date(tripStartDate);
      const endDate = new Date(tripStartDate);
      endDate.setDate(endDate.getDate() + baseItineraryConfig.length - 1);
      const formatDate = (date) => date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
      document.getElementById('tripDateRange').textContent = 
        `${formatDate(startDate)} - ${formatDate(endDate)} | å¤©æ°£é å ±ãƒ»æµ·æ‹”åˆ†æ`;
    }

    // --- å¤©æ°£æ¨¡çµ„ (æ”¹å›é«˜å¾·å¤©æ°£) ---
    async function loadWeather() {
      const currentItinerary = getItineraryConfig();
      const promises = currentItinerary.map(city => fetchAmapWeather(city));
      const weatherData = await Promise.all(promises);
      
      renderWeatherCards(weatherData);
      renderTemperatureChart(weatherData);
      renderStats(weatherData);
      
      document.getElementById('chartSection').style.display = 'block';
      document.getElementById('statsSection').style.display = 'grid';
    }

    // æ¨¡æ“¬å¤©æ°£æ•¸æ“šç”Ÿæˆå™¨
    function generateMockWeatherData(city) {
      const date = new Date(city.isoDate);
      const dayOfYear = Math.floor((date - new Date(date.getFullYear(), 0, 0)) / 86400000);
      
      // åŸºæ–¼åŸå¸‚å’Œæ—¥æœŸç”Ÿæˆç›¸å°åˆç†çš„å¤©æ°£æ•¸æ“š
      const baseTemp = city.location === 'æ•¦ç…Œ' ? 25 : 
                      city.location === 'è˜­å·' || city.location === 'è¥¿å¯§' ? 18 :
                      city.location === 'å¤§æŸ´æ—¦' || city.location === 'èŒ¶å¡' ? 12 : 20;
      
      const tempVariation = Math.sin(dayOfYear / 365 * Math.PI * 2) * 8;
      const randomVariation = (Math.random() - 0.5) * 6;
      
      const temperature = Math.round(baseTemp + tempVariation + randomVariation);
      const tempMin = Math.round(temperature - 8 - Math.random() * 4);
      
      const weatherOptions = ['æ™´', 'å¤šé›²', 'å°‘é›²', 'æ™´é–“å¤šé›²', 'é™°', 'å°é›¨', 'ä¸­é›¨'];
      const weights = [30, 25, 20, 15, 8, 2, 0]; // å¥½å¤©æ°£æ©Ÿç‡è¼ƒé«˜
      
      let totalWeight = weights.reduce((a, b) => a + b, 0);
      let random = Math.random() * totalWeight;
      let selectedWeather = weatherOptions[0];
      
      for (let i = 0; i < weatherOptions.length; i++) {
        random -= weights[i];
        if (random <= 0) {
          selectedWeather = weatherOptions[i];
          break;
        }
      }
      
      const windDirections = ['åŒ—é¢¨', 'å—é¢¨', 'æ±é¢¨', 'è¥¿é¢¨', 'æ±åŒ—é¢¨', 'è¥¿åŒ—é¢¨', 'æ±å—é¢¨', 'è¥¿å—é¢¨'];
      const windDirection = windDirections[Math.floor(Math.random() * windDirections.length)];
      const windPower = `${Math.floor(Math.random() * 4) + 1}ç´š`;
      
      return {
        ...city,
        status: 'SUCCESS',
        weather: selectedWeather,
        temperature: temperature,
        tempMin: tempMin,
        humidity: `${Math.floor(Math.random() * 30) + 40}%`,
        windDirection: windDirection,
        windPower: windPower,
        reportTime: new Date().toISOString(),
        error: null,
        note: 'æ¨¡æ“¬å¤©æ°£æ•¸æ“šï¼ˆAPI æš«æ™‚ä¸å¯ç”¨ï¼‰'
      };
    }

    async function fetchAmapWeather(city) {
      // --- è¨ºæ–·æ—¥èªŒ ---
      console.log(`[å¤©æ°£è¨ºæ–·] åœ°é»: ${city.location}, ç›®æ¨™æ—¥æœŸ: ${city.isoDate}, é«˜å¾·ä»£ç¢¼: ${city.adcode}`);

      try {
        // é«˜å¾·å¤©æ°£ API èª¿ç”¨
        const timestamp = new Date().getTime(); // é˜²å¿«å–æ©Ÿåˆ¶
        const url = `https://restapi.amap.com/v3/weather/weatherInfo?city=${city.adcode}&key=${AMAP_API_KEY}&extensions=all&_=${timestamp}`;
        
        console.log(`[å¤©æ°£è¨ºæ–·] API URL: ${url}`);
        
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹: ${response.status}`);
        
        const data = await response.json();
        if (data.status !== '1') {
          console.log(`[å¤©æ°£è¨ºæ–·] API å¤±æ•ˆï¼Œä½¿ç”¨æ¨¡æ“¬æ•¸æ“š: ${data.info}`);
          return generateMockWeatherData(city);
        }

        console.log(`[å¤©æ°£è¨ºæ–·] API è¿”å›æˆåŠŸï¼Œé å ±å¤©æ•¸: ${data.forecasts[0].casts.length}`);

        // æŸ¥æ‰¾ç•¶æ—¥é å ±
        const forecasts = data.forecasts[0].casts;
        const specificForecast = forecasts.find(cast => cast.date === city.isoDate);

        console.log(`[å¤©æ°£è¨ºæ–·] åŒ¹é…çš„é å ±æ—¥æœŸ: ${specificForecast ? specificForecast.date : 'ç„¡åŒ¹é…'}`);

        if (!specificForecast) {
          // å¦‚æœæ‰¾ä¸åˆ°ç•¶æ—¥é å ±ï¼Œä½¿ç”¨ä»Šå¤©çš„é å ±
          const todayForecast = forecasts[0];
          console.log(`[å¤©æ°£è¨ºæ–·] ä½¿ç”¨ä»Šæ—¥é å ±æ›¿ä»£: ${todayForecast.date}`);
          
          return {
            ...city,
            status: 'SUCCESS',
            weather: todayForecast.dayweather,
            temperature: parseInt(todayForecast.daytemp),
            tempMin: parseInt(todayForecast.nighttemp),
            humidity: 'æœªæä¾›',
            windDirection: todayForecast.daywind,
            windPower: todayForecast.daypower,
            reportTime: new Date().toISOString(),
            forecasts: forecasts,
            error: null,
            note: 'ä½¿ç”¨ä»Šæ—¥é å ±æ•¸æ“š'
          };
        }

        return {
          ...city,
          status: 'SUCCESS',
          weather: specificForecast.dayweather,
          temperature: parseInt(specificForecast.daytemp),
          tempMin: parseInt(specificForecast.nighttemp),
          humidity: 'æœªæä¾›',
          windDirection: specificForecast.daywind,
          windPower: specificForecast.daypower,
          reportTime: new Date().toISOString(),
          forecasts: forecasts,
          error: null
        };
      } catch (error) {
        console.error(`ç²å– ${city.location} å¤©æ°£å¤±æ•—:`, error);
        console.log(`[å¤©æ°£è¨ºæ–·] ä½¿ç”¨æ¨¡æ“¬æ•¸æ“šä½œç‚ºå‚™ç”¨æ–¹æ¡ˆ`);
        return generateMockWeatherData(city);
      }
    }

    function renderWeatherCards(weatherData) {
      const weatherGrid = document.getElementById('weather-grid');
      weatherGrid.innerHTML = '';

      weatherData.forEach(data => {
        let cardHtml = '';
        const hasError = data.status === 'FETCH_FAILED';

        if (hasError) {
          const reason = data.error;

          cardHtml = `
          <div class="card bg-gray-100 rounded-xl p-6 opacity-70">
            <div>
              <div class="flex justify-between items-start mb-4">
                <div>
                  <h3 class="text-xl font-semibold text-gray-600">${data.day} ${data.location}</h3>
                  <p class="text-gray-500 text-sm">${data.date}</p>
                </div>
                <span class="tag bg-gray-300 text-gray-600"><i class="fas fa-exclamation-triangle mr-1"></i> éŒ¯èª¤</span>
              </div>
              <div class="text-center py-8">
                <p class="font-semibold text-gray-700">æ•¸æ“šç²å–å¤±æ•—</p>
                <p class="text-xs text-gray-500 mt-1">${reason}</p>
              </div>
              <div class="border-t border-slate-200 pt-3 mt-3">
                <h4 class="font-medium text-gray-600 mb-1">è¡Œç¨‹</h4>
                <p class="text-slate-600 text-sm">${data.itinerary}</p>
              </div>
            </div>
          </div>`;
        } else {
          const weatherInfo = getWeatherVisuals(data.weather);
          const tempDisplay = `${data.temperature}Â°C`;
          const forecastTemp = `${data.temperature}Â°C / ${data.tempMin}Â°C`;

          const altWarning = data.alt > 3000 ? `<div class="mb-2"><span class="tag alt-high"><i class="fas fa-exclamation-triangle mr-1 warning"></i>é«˜æµ·æ‹” ${data.alt}m</span></div>` : data.alt > 2500 ? `<div class="mb-2"><span class="tag alt-mid"><i class="fas fa-mountain mr-1"></i>ä¸­æµ·æ‹” ${data.alt}m</span></div>` : `<div class="mb-2"><span class="tag alt-low"><i class="fas fa-check mr-1"></i>èˆ’é©æµ·æ‹” ${data.alt}m</span></div>`;

          cardHtml = `
          <div class="card bg-white rounded-xl p-6">
            <div>
              <div class="flex justify-between items-start mb-4">
                <div>
                  <h3 class="text-xl font-semibold">${data.day} ${data.location}</h3>
                  <p class="text-slate-500 text-sm">${data.date}</p>
                  <p class="text-slate-400 text-xs">${data.fullDate}</p>
                  ${data.note ? `<p class="text-orange-500 text-xs">âš ï¸ ${data.note}</p>` : ''}
                </div>
                <span class="tag ${weatherInfo.color}"><i class="fas ${weatherInfo.icon} mr-1"></i> ${data.weather}</span>
              </div>
              ${altWarning}
              <div class="flex items-center justify-between mb-4">
                <div class="text-4xl font-bold">${tempDisplay}</div>
                <div class="text-slate-600 text-sm">
                  <div><i class="fas fa-thermometer-half mr-1"></i> é å ±: ${forecastTemp}</div>
                  <div><i class="fas fa-wind mr-1"></i> ${data.windDirection} ${data.windPower}</div>
                  <div><i class="fas fa-tint mr-1"></i> æ¿•åº¦: ${data.humidity}</div>
                </div>
              </div>
              ${data.alt > 3000 ? '<div class="bg-red-50 p-3 rounded-lg mb-3"><p class="text-red-600 font-semibold text-sm"><i class="fas fa-exclamation-circle mr-1"></i>é«˜åŸåæ‡‰é è­¦</p><p class="text-xs text-red-500">å»ºè­°ï¼šå¤šå–æ°´ï¼Œé¿å…åŠ‡çƒˆé‹å‹•</p></div>' : ''}
              <div class="border-t border-slate-100 pt-3 mt-3"><h4 class="font-medium mb-1">è¡Œç¨‹</h4><p class="text-slate-600 text-sm">${data.itinerary}</p></div>
              <div class="border-t border-slate-100 pt-3 mt-3"><h4 class="font-medium mb-1">ç©¿æ­å»ºè­°</h4><p class="text-slate-600 text-sm">${data.outfit}</p></div>
            </div>
            <div class="mt-4 text-xs text-slate-400"><i class="fas fa-clock mr-1"></i>æ•¸æ“šæ›´æ–°æ–¼: ${new Date(data.reportTime).toLocaleString()}</div>
            ${data.note ? `<div class="mt-2 p-2 bg-orange-100 text-orange-700 rounded-md text-sm font-semibold"><i class="fas fa-exclamation-circle mr-1"></i>${data.note}</div>` : ''}
          </div>`;
        }
        weatherGrid.innerHTML += cardHtml;
      });
    }

    function renderTemperatureChart(weatherData) {
      const ctx = document.getElementById('tempChart').getContext('2d');
      if (tempChart) tempChart.destroy();

      const validData = weatherData.filter(d => d.status === 'SUCCESS');
      const labels = validData.map(d => `${d.day}\n${d.location}`);
      const dayTemps = validData.map(d => d.temperature);
      const nightTemps = validData.map(d => d.tempMin);

      tempChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            { label: 'é å ±é«˜æº« (Â°C)', data: dayTemps, borderColor: '#ef4444', tension: 0.3, fill: false },
            { label: 'é å ±ä½æº« (Â°C)', data: nightTemps, borderColor: '#3b82f6', tension: 0.3, fill: false }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          scales: { y: { beginAtZero: false, title: { display: true, text: 'æº«åº¦ (Â°C)' } } },
          plugins: { legend: { display: true, position: 'top' }, tooltip: { mode: 'index', intersect: false } }
        }
      });
    }

    function renderStats(weatherData) {
      const validData = weatherData.filter(d => d.status === 'SUCCESS');
      const avgTemp = validData.length > 0 ? (validData.reduce((sum, d) => sum + d.temperature, 0) / validData.length).toFixed(1) : '--';
      const goodWeatherCount = validData.filter(d => d.weather.includes('æ™´') || d.weather.includes('å¤šé›²')).length;
      const rainyWeatherCount = validData.filter(d => d.weather.includes('é›¨') || d.weather.includes('é›·') || d.weather.includes('é›ª')).length;

      document.getElementById('avgTemp').textContent = avgTemp !== '--' ? `${avgTemp}Â°C` : '--';
      document.getElementById('goodWeatherDays').textContent = `${goodWeatherCount} å¤©`;
      document.getElementById('rainyDays').textContent = `${rainyWeatherCount} å¤©`;
    }

    function getWeatherVisuals(weather) {
      if (weather.includes('é›¨') || weather.includes('é›·')) return { icon: 'fa-cloud-rain', color: 'rainy' };
      if (weather.includes('é›ª')) return { icon: 'fa-snowflake', color: 'rainy' };
      if (weather.includes('æ™´')) return { icon: 'fa-sun', color: 'sunny' };
      if (weather.includes('é™°') || weather.includes('å¤šé›²') || weather.includes('é›²')) return { icon: 'fa-cloud', color: 'cloudy' };
      if (weather.includes('éœ§') || weather.includes('éœ¾')) return { icon: 'fa-smog', color: 'cloudy' };
      return { icon: 'fa-question-circle', color: 'cloudy' };
    }
    
    // --- æµ·æ‹”æ¨¡çµ„ ---
    async function loadAltitude() {
        const currentItinerary = getItineraryConfig();
        const alts = currentItinerary.map(c => c.alt);
      const max = Math.max(...alts), min = Math.min(...alts);
      document.getElementById('maxAlt').textContent = `${max} m`;
      document.getElementById('minAlt').textContent = `${min} m`;
      const high = alts.filter(a => a > 3000).length;
      document.getElementById('altRisk').textContent = high > 3 ? 'é«˜' : high > 1 ? 'ä¸­' : 'ä½';
        renderAltChart();
    }

    function renderAltChart() {
      const ctx = document.getElementById('altChart').getContext('2d');
      if (altChart) altChart.destroy();
       const currentItinerary = getItineraryConfig();
      altChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: currentItinerary.map(c => `${c.day} ${c.location}`),
          datasets: [{
            label: 'æµ·æ‹”é«˜åº¦ (m)',
            data: currentItinerary.map(c => c.alt),
            borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)',
            fill: true, tension: 0.3,
            pointBackgroundColor: currentItinerary.map(c => c.alt > 3000 ? '#ef4444' : c.alt > 2500 ? '#f59e0b' : '#10b981')
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: { callbacks: { afterLabel: (ctx) => { const alt = ctx.parsed.y; if (alt > 3000) return 'âš ï¸ é«˜åŸåæ‡‰é¢¨éšª'; if (alt > 2500) return 'æ³¨æ„é˜²æ›¬ä¿æš–'; return 'èˆ’é©æµ·æ‹”'; } } } },
          scales: { y: { beginAtZero: false, title: { display: true, text: 'æµ·æ‹” (ç±³)' } } }
        }
      });
    }

    // --- UI è¼”åŠ©å‡½æ•¸ ---
    function showLoading() {
      document.getElementById('weather-grid').innerHTML = `<div class="col-span-full text-center py-12"><i class="fas fa-spinner spinner text-4xl text-blue-500 mb-4"></i><p class="text-lg font-medium">æ­£åœ¨è¼‰å…¥å¤©æ°£æ•¸æ“š...</p></div>`;
    }
    
    function showError(message) {
        document.getElementById('weather-grid').innerHTML = `<div class="col-span-full text-center py-12 bg-red-50 rounded-lg"><p class="text-red-600">${message}</p></div>`;
    }
    
    // --- åˆ†äº«åŠŸèƒ½ ---
    function shareWeatherForecast() {
      const startDate = new Date(tripStartDate);
      const endDate = new Date(tripStartDate);
      endDate.setDate(endDate.getDate() + baseItineraryConfig.length - 1);
      const formatDate = (date) => date.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric' });

      const shareText = `ğŸŒ¤ï¸ ç”˜é’10æ—¥è¡Œç¨‹æ™ºèƒ½åŠ©æ‰‹\nğŸ“… ${formatDate(startDate)} - ${formatDate(endDate)}\nğŸ—ºï¸ è˜­å·â†’é–€æºâ†’å¼µæ–â†’å˜‰å³ªé—œâ†’æ•¦ç…Œâ†’å¤§æŸ´æ—¦â†’èŒ¶å¡â†’è¥¿å¯§\nâ›°ï¸ åŒ…å«æµ·æ‹”é è­¦å’Œé«˜åŸåæ‡‰æé†’\nğŸŒ¡ï¸ å¯¦æ™‚å¤©æ°£é å ±èˆ‡å‹•æ…‹æ—¥æœŸ\n\nğŸ“± æŸ¥çœ‹è©³ç´°: ${window.location.href}`;

      if (navigator.share) {
        navigator.share({ title: 'ç”˜é’10æ—¥è¡Œç¨‹æ™ºèƒ½åŠ©æ‰‹', text: shareText, url: window.location.href })
          .catch(() => fallbackShare(shareText));
      } else {
        fallbackShare(shareText);
      }
    }

    function fallbackShare(shareText) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(shareText).then(() => {
          showShareSuccess('è¡Œç¨‹ä¿¡æ¯å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼');
        });
      }
    }

    function showShareSuccess(message) {
      const alert = document.createElement('div');
      alert.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
      alert.innerHTML = `<i class="fas fa-check mr-2"></i>${message}`;
      document.body.appendChild(alert);
      setTimeout(() => alert.remove(), 3000);
    }
  </script>
</body>
</html> 